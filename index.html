<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALENDAXIS DA COMUNICA</title>
    <style>
        :root {
            --bg-color: #0b0b0b;
            --card-bg: #1e1e1e;
            --primary-green: #1cff6a;
            --dark-green: #0f3d24;
            --medium-green: #2aff87;
            --light-green: #6cffb2;
            --white: #ffffff;
            --text-gray: #a0a0a0;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--white);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: rgba(11, 11, 11, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--dark-green);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo-placeholder {
            width: 50px;
            height: 50px;
            background: var(--primary-green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--bg-color);
            box-shadow: 0 0 15px rgba(28, 255, 106, 0.4);
        }

        header h1 {
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 800;
            background: linear-gradient(to right, var(--white), var(--primary-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Dashboard Layout */
        main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Calendar Controls */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .current-month-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--white);
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn-nav {
            background: var(--card-bg);
            border: 1px solid var(--dark-green);
            color: var(--white);
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-nav:hover {
            border-color: var(--primary-green);
            color: var(--primary-green);
            box-shadow: 0 0 10px rgba(28, 255, 106, 0.2);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .weekday-label {
            text-align: center;
            padding: 1rem;
            color: var(--primary-green);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .day-cell {
            background: var(--card-bg);
            min-height: 120px;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .day-cell:hover {
            border-color: var(--primary-green);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(28, 255, 106, 0.1);
        }

        .day-cell.today {
            border-color: var(--primary-green);
            background: rgba(28, 255, 106, 0.05);
        }

        .day-cell.other-month {
            opacity: 0.2;
            cursor: default;
            pointer-events: none;
        }

        .day-number {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Badges on Calendar */
        .post-badges {
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow: hidden;
        }

        .badge {
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--bg-color);
            font-weight: 600;
        }

        /* Side Panel */
        .side-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: var(--card-bg);
            z-index: 200;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.8);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            border-left: 2px solid var(--primary-green);
        }

        .side-panel.active {
            right: 0;
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--dark-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Form */
        .post-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        input, select, textarea {
            background: var(--bg-color);
            border: 1px solid var(--dark-green);
            padding: 0.8rem;
            color: var(--white);
            border-radius: 6px;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-green);
        }

        .btn-save {
            background: var(--primary-green);
            color: var(--bg-color);
            border: none;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.5rem;
        }

        .btn-save:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(28, 255, 106, 0.4);
        }

        /* Post Cards in Panel */
        .posts-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .post-card {
            padding: 1rem;
            border-radius: 8px;
            position: relative;
            animation: slideIn 0.3s ease-out;
            color: var(--bg-color);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .post-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .post-card-text {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .post-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-action {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .btn-action:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Types Colors */
        .type-eventos { background-color: #1cff6a; }
        .type-esportivo { background-color: #2aff87; }
        .type-social { background-color: #6cffb2; }
        .type-patrimonio { background-color: #0f3d24; color: var(--white) !important; }
        .type-esports { background-color: #00ffcc; }
        .type-comissao { background-color: #adff2f; }
        .type-outros { background-color: #ffffff; }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 150;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Custom Notification */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-green);
            color: var(--bg-color);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            display: none;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .calendar-grid { grid-template-columns: repeat(1, 1fr); }
            .side-panel { width: 100%; right: -100%; }
            .weekday-label { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo-placeholder">AXIS</div>
            <h1>CALENDAXIS DA COMUNICA</h1>
        </div>
        <div class="user-status" id="user-status">Conectando...</div>
    </header>

    <main>
        <div class="calendar-controls">
            <div class="current-month-display" id="month-display">Janeiro 2026</div>
            <div class="nav-buttons">
                <button class="btn-nav" id="prev-btn">Anterior</button>
                <button class="btn-nav" id="next-btn">Próximo</button>
            </div>
        </div>

        <div class="calendar-grid" id="calendar-grid">
            <!-- Labels -->
            <div class="weekday-label">Dom</div>
            <div class="weekday-label">Seg</div>
            <div class="weekday-label">Ter</div>
            <div class="weekday-label">Qua</div>
            <div class="weekday-label">Qui</div>
            <div class="weekday-label">Sex</div>
            <div class="weekday-label">Sáb</div>
            <!-- Days injected here -->
        </div>
    </main>

    <div class="overlay" id="overlay"></div>

    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <h2 id="panel-date-title">Data Selecionada</h2>
            <button class="close-btn" id="close-panel">&times;</button>
        </div>
        <div class="panel-content">
            <div class="post-form">
                <input type="hidden" id="edit-id">
                <div class="input-group">
                    <label>Horário</label>
                    <input type="time" id="post-time" required>
                </div>
                <div class="input-group">
                    <label>Tipo de Post</label>
                    <select id="post-type">
                        <option value="eventos">Eventos</option>
                        <option value="esportivo">Esportivo</option>
                        <option value="social">Social</option>
                        <option value="patrimonio">Patrimônio</option>
                        <option value="esports">E-sports</option>
                        <option value="comissao">Comissão</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>O que será postado?</label>
                    <textarea id="post-text" rows="3" placeholder="Ex: Divulgação do interbatucada..."></textarea>
                </div>
                <button class="btn-save" id="save-post">SALVAR POST</button>
            </div>

            <h3 style="margin-bottom: 1rem; border-bottom: 1px solid var(--dark-green); padding-bottom: 0.5rem;">Posts do Dia</h3>
            <div class="posts-list" id="posts-list">
                <!-- Posts dynamic list -->
            </div>
        </div>
    </div>

    <div id="toast">Ação realizada com sucesso!</div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuração
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'calendaxis-axis';

        // State
        let currentMonth = 0; // Janeiro
        const year = 2026;
        let selectedDate = null;
        let allPosts = [];
        let currentUser = null;

        const months = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];

        // Elements
        const calendarGrid = document.getElementById('calendar-grid');
        const monthDisplay = document.getElementById('month-display');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const sidePanel = document.getElementById('side-panel');
        const overlay = document.getElementById('overlay');
        const closePanel = document.getElementById('close-panel');
        const panelDateTitle = document.getElementById('panel-date-title');
        const postsList = document.getElementById('posts-list');
        const toast = document.getElementById('toast');

        // Form fields
        const inputEditId = document.getElementById('edit-id');
        const inputTime = document.getElementById('post-time');
        const inputType = document.getElementById('post-type');
        const inputText = document.getElementById('post-text');
        const saveBtn = document.getElementById('save-post');

        // Initialization
        async function init() {
            // Rule 3: Auth First & Handle Custom Token
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('user-status').textContent = `ID: ${user.uid.substring(0,6)}...`;
                        startListening();
                    }
                });
            } catch (error) {
                console.error("Auth error", error);
                document.getElementById('user-status').textContent = "Erro de Auth";
            }

            renderCalendar();
        }

        // Real-time listener
        function startListening() {
            if (!currentUser) return;

            // Rule 1 & 2: Collection Path & Simple Query
            const postsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            
            onSnapshot(postsCollection, (snapshot) => {
                allPosts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderCalendar();
                if (selectedDate) updatePanelPosts();
            }, (error) => {
                console.error("Firestore error details:", error);
            });
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        // Calendar Logic
        function renderCalendar() {
            const labels = Array.from(calendarGrid.querySelectorAll('.weekday-label'));
            calendarGrid.innerHTML = '';
            labels.forEach(l => calendarGrid.appendChild(l));

            monthDisplay.textContent = `${months[currentMonth]} ${year}`;

            const firstDayOfMonth = new Date(year, currentMonth, 1).getDay();
            const daysInMonth = new Date(year, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell other-month';
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                
                const today = new Date();
                if (today.getFullYear() === year && today.getMonth() === currentMonth && today.getDate() === day) {
                    cell.classList.add('today');
                }

                cell.innerHTML = `<div class="day-number">${day}</div>`;
                
                const dayPosts = allPosts.filter(p => p.date === dateStr);
                const badgeContainer = document.createElement('div');
                badgeContainer.className = 'post-badges';
                
                dayPosts.sort((a,b) => a.hora.localeCompare(b.hora)).forEach(post => {
                    const b = document.createElement('div');
                    b.className = `badge type-${post.tipo}`;
                    b.textContent = `${post.hora} - ${post.texto.substring(0, 15)}...`;
                    badgeContainer.appendChild(b);
                });

                cell.appendChild(badgeContainer);
                cell.onclick = () => openPanel(dateStr);
                calendarGrid.appendChild(cell);
            }
        }

        function openPanel(date) {
            selectedDate = date;
            const formatted = date.split('-').reverse().join('/');
            panelDateTitle.textContent = formatted;
            
            inputEditId.value = '';
            inputTime.value = '';
            inputText.value = '';
            saveBtn.textContent = 'SALVAR POST';

            updatePanelPosts();
            
            sidePanel.classList.add('active');
            overlay.classList.add('active');
        }

        function closePanelFn() {
            sidePanel.classList.remove('active');
            overlay.classList.remove('active');
            selectedDate = null;
        }

        function updatePanelPosts() {
            if (!selectedDate) return;
            
            const dayPosts = allPosts.filter(p => p.date === selectedDate);
            dayPosts.sort((a,b) => a.hora.localeCompare(b.hora));

            postsList.innerHTML = '';
            
            if (dayPosts.length === 0) {
                postsList.innerHTML = `<p style="color: var(--text-gray); text-align: center; margin-top: 2rem;">Nenhum post agendado.</p>`;
                return;
            }

            dayPosts.forEach(post => {
                const card = document.createElement('div');
                card.className = `post-card type-${post.tipo}`;
                card.innerHTML = `
                    <div class="post-card-header">
                        <span>${post.tipo.toUpperCase()}</span>
                        <span>${post.hora}</span>
                    </div>
                    <div class="post-card-text">${post.texto}</div>
                    <div class="post-actions">
                        <button class="btn-action edit-btn">Editar</button>
                        <button class="btn-action delete-btn">Excluir</button>
                    </div>
                `;

                card.querySelector('.edit-btn').onclick = () => editPost(post);
                card.querySelector('.delete-btn').onclick = () => removePost(post.id);

                postsList.appendChild(card);
            });
        }

        async function savePost() {
            if (!currentUser) return;
            if (!selectedDate || !inputTime.value || !inputText.value) {
                showToast("Preencha todos os campos!");
                return;
            }

            const postData = {
                date: selectedDate,
                hora: inputTime.value,
                tipo: inputType.value,
                texto: inputText.value,
                userId: currentUser.uid,
                updatedAt: new Date().toISOString()
            };

            try {
                if (inputEditId.value) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', inputEditId.value);
                    await updateDoc(docRef, postData);
                    showToast("Post atualizado!");
                } else {
                    const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    await addDoc(postsCol, postData);
                    showToast("Post agendado!");
                }

                inputEditId.value = '';
                inputTime.value = '';
                inputText.value = '';
                saveBtn.textContent = 'SALVAR POST';
                
            } catch (e) {
                console.error("Save error", e);
                showToast("Erro ao salvar.");
            }
        }

        function editPost(post) {
            inputEditId.value = post.id;
            inputTime.value = post.hora;
            inputType.value = post.tipo;
            inputText.value = post.texto;
            saveBtn.textContent = 'ATUALIZAR POST';
            document.querySelector('.panel-content').scrollTop = 0;
        }

        async function removePost(id) {
            if (!currentUser) return;
            if (!confirm("Deseja realmente excluir este post?")) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', id);
                await deleteDoc(docRef);
                showToast("Post removido.");
            } catch (e) {
                showToast("Erro ao excluir.");
            }
        }

        prevBtn.onclick = () => {
            if (currentMonth > 0) {
                currentMonth--;
                renderCalendar();
            }
        };

        nextBtn.onclick = () => {
            if (currentMonth < 11) {
                currentMonth++;
                renderCalendar();
            }
        };

        saveBtn.onclick = savePost;
        closePanel.onclick = closePanelFn;
        overlay.onclick = closePanelFn;

        window.onload = init;
    </script>
</body>
</html>